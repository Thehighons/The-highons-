<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The Highon's - Premium creative supplies including keychains, art supplies, stationery, and diaries. Shop now for high-quality products.">
  <title>The Highon's - Creative Supplies | Premium Keychains, Art Materials & Stationery</title>
  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Inline Styles -->
  <style>
    @font-face {
      font-family: 'Trajan Pro';
      /* src: url('trajan-pro.woff2') format('woff2'), url('trajan-pro.woff') format('woff'); */
      font-display: swap; /* Improves perceived performance */
    }
    :root {
      --primary: #2A2D34;    /* Deep Navy */
      --secondary: #5C6B73;  /* Steel Blue */
      --accent: #D4A373;     /* Warm Gold */
      --dark: #1A1A1A;       /* Dark Text */
      --light: #F8F9FA;      /* Light Background */
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--light);
      color: var(--dark);
    }
    /* Prevent body scroll when cart is open */
    body.overflow-hidden {
      overflow: hidden;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
      color: var(--primary);
    }
    .brand-name {
      font-family: 'Trajan Pro', 'Times New Roman', serif; /* Added fallback */
      letter-spacing: 1px;
      color: var(--primary);
    }
    .product-card {
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      background: white;
      border-radius: 12px;
      overflow: hidden;
      display: flex; /* Use flexbox for better structure */
      flex-direction: column;
      height: 100%; /* Make cards equal height in a grid row */
    }
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    .product-card-content {
        padding: 1rem; /* Use px-4 pb-4 equivalent */
        flex-grow: 1; /* Allow content to grow */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Push controls to bottom */
    }
    .product-card-controls {
        margin-top: auto; /* Pushes controls to the bottom */
    }
    .category-title {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 12px 32px;
      border-radius: 8px;
      display: inline-block;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .nav-link {
      position: relative;
      color: var(--secondary);
      transition: all 0.3s ease;
    }
    .nav-link:hover {
      color: var(--primary);
    }
    .hero-gradient {
      background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      transition: all 0.3s ease;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem; /* Consistent padding */
      border-radius: 9999px; /* pill shape */
      font-weight: 500; /* medium */
    }
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(42, 45, 52, 0.2);
    }
    /* Style for the filter dropdown */
    #categoryFilter {
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%235C6B73"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.2em 1.2em;
      padding-right: 2.5rem; /* Make space for the arrow */
    }
    .feature-icon {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 10px rgba(42, 45, 52, 0.2);
    }
    .feature-card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }

    /* Cart Panel Styling */
    .cart-panel {
      background: white;
      box-shadow: -8px 0 32px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      right: -100%; /* Start hidden off-screen */
      width: 380px;
      max-width: 90vw;
      height: 100vh;
      overflow-y: auto;
      z-index: 60; /* Above overlay, below modal */
      transition: right 0.4s ease-in-out;
      display: flex;
      flex-direction: column; /* Allow header/footer */
    }
    .cart-panel.open {
      right: 0; /* Slide in */
    }
    .cart-panel-content {
        flex-grow: 1;
        overflow-y: auto; /* Scroll only content */
        padding: 1.5rem; /* p-6 */
    }
    .cart-panel-footer {
        padding: 1.5rem; /* p-6 */
        border-top: 1px solid #e5e7eb; /* border-gray-200 */
        background-color: #f9fafb; /* bg-gray-50 */
    }

    /* Overlay Styling */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease-in-out, visibility 0s 0.4s; /* Delay hiding visibility */
      z-index: 55; /* Below cart, above content */
    }
    .overlay.active {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.4s ease-in-out; /* Only transition opacity */
    }

    .loader {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid var(--primary); /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes float {
      0% { transform: translateY(0px) rotate(-2deg); }
      50% { transform: translateY(-15px) rotate(2deg); }
      100% { transform: translateY(0px) rotate(-2deg); }
    }
    .floating {
      animation: float 4s ease-in-out infinite;
    }
    .image-scale {
      transition: transform 0.4s ease;
    }
    .image-scale:hover {
      transform: scale(1.08);
    }

    /* Ensure buttons within cart panel are styled consistently */
    .cart-panel .quantity-btn {
        background-color: #e5e7eb; /* bg-gray-200 */
        color: #374151; /* text-gray-700 */
        width: 1.75rem; /* w-7 */
        height: 1.75rem; /* h-7 */
        border-radius: 9999px; /* rounded-full */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        font-size: 0.875rem; /* text-md */
        font-weight: bold;
        line-height: 1; /* Ensure '+' and '-' are centered vertically */
        cursor: pointer; /* Add cursor pointer */
    }
    .cart-panel .quantity-btn:hover {
        background-color: #d1d5db; /* hover:bg-gray-300 */
    }
    .cart-panel .quantity-display {
        margin-left: 0.25rem;
        margin-right: 0.25rem;
        font-weight: 500;
        width: 1.25rem; /* w-5 */
        text-align: center;
    }
    /* Ensure quantity buttons on product cards are also styled */
     .product-card .quantity-btn {
        background-color: #e5e7eb; /* bg-gray-200 */
        color: #374151; /* text-gray-700 */
        width: 2rem; /* w-8 */
        height: 2rem; /* h-8 */
        border-radius: 9999px; /* rounded-full */
        display: inline-flex; /* Use inline-flex */
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        font-size: 1rem; /* text-lg */
        font-weight: bold;
        line-height: 1;
        cursor: pointer; /* Add cursor pointer */
        border: none; /* Remove default button border */
    }
    .product-card .quantity-btn:hover {
        background-color: #d1d5db; /* hover:bg-gray-300 */
    }
     .product-card .quantity-display {
        margin-left: 0.5rem; /* mx-2 */
        margin-right: 0.5rem; /* mx-2 */
        font-weight: 600; /* font-semibold */
        font-size: 1rem; /* text-lg */
        min-width: 1.5rem; /* Ensure space for number */
        text-align: center;
        display: inline-block; /* Make it inline */
        vertical-align: middle; /* Align vertically */
    }
     .product-card .quantity-controls { /* Wrapper div */
        display: flex;
        align-items: center;
        justify-content: space-between; /* Or center, depending on desired layout */
     }

  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Navbar -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
      <div class="flex items-center">
        <span class="text-2xl font-bold tracking-wide brand-name">THE HIGHON'S</span>
      </div>
      <nav class="hidden md:flex items-center space-x-8">
        <a href="#products" class="nav-link">Products</a>
        <a href="#features" class="nav-link">Why Choose Us</a>
        <a href="#order" class="nav-link">Order</a>
        <a href="#request" class="nav-link">Request Product</a>
        <a href="#contact" class="nav-link">Contact</a>
        <div class="relative ml-4">
          <!-- DESKTOP CART BUTTON -->
          <button onclick="toggleCart()" class="flex items-center relative text-gray-600 hover:text-gray-800">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="cartCounter" class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
          </button>
        </div>
        <button id="logoutButtonDesktop" onclick="logout()" class="ml-4 text-sm btn-primary px-4 py-2 rounded-full hidden">Logout</button>
      </nav>
      <div class="md:hidden flex items-center space-x-4">
        <!-- MOBILE CART BUTTON -->
        <button onclick="toggleCart()" class="flex items-center relative text-gray-600 hover:text-gray-800">
          <i class="fas fa-shopping-cart text-xl"></i>
          <span id="cartCounterMobile" class="absolute -top-2 -right-2 bg-purple-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
        </button>
        <button onclick="toggleMobileMenu()" class="text-gray-700">
          <i class="fas fa-bars text-2xl"></i>
        </button>
      </div>
    </div>
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-gray-200 p-4">
      <div class="flex flex-col space-y-4">
        <a href="#products" class="nav-link block py-2" onclick="toggleMobileMenu()">Products</a>
        <a href="#features" class="nav-link block py-2" onclick="toggleMobileMenu()">Why Choose Us</a>
        <a href="#order" class="nav-link block py-2" onclick="toggleMobileMenu()">Order</a>
        <a href="#request" class="nav-link block py-2" onclick="toggleMobileMenu()">Request Product</a>
        <a href="#contact" class="nav-link block py-2" onclick="toggleMobileMenu()">Contact</a>
        <button id="logoutButtonMobile" onclick="logout()" class="text-sm btn-primary px-4 py-2 rounded-full w-full mt-4 hidden">Logout</button>
      </div>
    </div>
  </header>

  <!-- Cart Panel -->
  <div class="overlay" id="cartOverlay" onclick="toggleCart()"></div>
  <div class="cart-panel" id="cartPanel">
      <div class="cart-panel-content">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">Your Cart</h3>
              <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none align-middle">×</button>
          </div>
          <div id="cartPanelItems" class="space-y-4 mb-6">
            <!-- Cart items will be loaded here -->
            <p id="emptyCartMessage" class="text-center text-gray-500">Your cart is empty.</p>
          </div>
      </div>
      <div id="cartPanelFooter" class="cart-panel-footer hidden"> <!-- Initially hidden -->
          <div class="border-t border-gray-200 pt-4 mb-6">
              <div class="flex justify-between mb-2">
                  <span class="font-semibold">Subtotal:</span>
                  <span class="font-semibold">₹<span id="cartPanelSubtotal">0</span></span>
              </div>
              <div id="discountRow" class="flex justify-between mb-2 hidden">
                  <span class="font-semibold">Discount:</span>
                  <span class="font-semibold text-green-600">-₹<span id="cartPanelDiscount">0</span></span>
              </div>
              <div class="flex justify-between text-lg font-bold">
                  <span>Total:</span>
                  <span>₹<span id="cartPanelTotal">0</span></span>
              </div>
          </div>
          <div class="mb-4">
              <label for="cartCoupon" class="block font-semibold mb-2 text-gray-700">Coupon Code:</label>
              <div class="flex">
                  <input type="text" id="cartCoupon" placeholder="Enter coupon code" class="flex-1 p-3 border border-gray-200 rounded-l-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                  <button onclick="applyCoupon()" class="bg-purple-600 text-white px-4 py-3 rounded-r-lg hover:bg-purple-700 transition">Apply</button>
              </div>
          </div>
          <button onclick="proceedToCheckout()" class="block w-full btn-primary text-white py-3 rounded-lg font-medium text-center">Proceed to Checkout</button>
      </div>
  </div>

  <!-- Hero Section -->
  <section class="text-center hero-gradient pt-20 pb-12">
    <div class="max-w-4xl mx-auto px-6">
      <img src="GridArt_20250425_064014157.png" alt="The Highon's Logo" class="logo mb-6 animate__animated animate__fadeIn w-48 mx-auto" loading="lazy">
      <h2 class="text-5xl font-bold mb-6 text-gray-800 animate__animated animate__fadeInDown">Create Bold. Create Bright.</h2>
      <p class="text-xl mb-10 text-gray-600 max-w-2xl mx-auto animate__animated animate__fadeIn animate__delay-1s">Welcome to The Highon's — where creativity meets purpose through premium supplies.</p>
      <a href="#products" class="inline-block btn-primary text-white px-10 py-4 rounded-full shadow-lg font-medium animate__animated animate__fadeIn animate__delay-2s">Explore Our Collection</a>
    </div>
    <div class="mt-12 flex justify-center space-x-8">
      <div class="floating animate__animated animate__fadeIn animate__delay-3s">
        <img src="Screenshot_20250422_132243_Meesho.jpg" alt="Keychain product" class="w-32 h-32 rounded-lg object-cover shadow-xl image-scale" loading="lazy">
      </div>
      <div class="floating animate__animated animate__fadeIn animate__delay-4s" style="animation-delay: 0.5s">
        <img src="Screenshot_20250424_134214_Meesho.jpg" alt="Art supplies" class="w-32 h-32 rounded-lg object-cover shadow-xl image-scale" loading="lazy">
      </div>
      <div class="floating animate__animated animate__fadeIn animate__delay-5s" style="animation-delay: 1s">
        <img src="81EROqfMQBL._AC_UF1000,1000_QL80_.jpg" alt="Diary product" class="w-32 h-32 rounded-lg object-cover shadow-xl image-scale" loading="lazy">
      </div>
    </div>
  </section>

  <!-- Features -->
  <section id="features" class="py-20 bg-gray-50 px-6">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-4xl font-bold mb-12 text-center text-gray-800">Why Choose The Highon's</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="feature-card animate__animated">
          <div class="feature-icon">
            <i class="fas fa-award"></i>
          </div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Premium Quality</h3>
          <p class="text-gray-600">We source only the highest quality materials to ensure your creative projects shine.</p>
        </div>
        <div class="feature-card animate__animated">
          <div class="feature-icon">
            <i class="fas fa-truck"></i>
          </div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Local Delivery Only</h3>
          <p class="text-gray-600">Delivery within Navsari with careful packaging to protect your items.</p>
        </div>
        <div class="feature-card animate__animated">
          <div class="feature-icon">
            <i class="fas fa-headset"></i>
          </div>
          <h3 class="text-xl font-bold mb-3 text-gray-800">Dedicated Support</h3>
          <p class="text-gray-600">Our team is always ready to help with any questions about our products.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Products -->
  <section id="products" class="py-20 bg-white px-6">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-4xl font-bold mb-6 text-center text-gray-800">Our Premium Collection</h2>
      <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
          <div class="relative w-full md:w-1/2 lg:w-1/3">
            <input type="text" id="productSearch" placeholder="Search products..." class="w-full p-4 pl-12 border border-gray-200 rounded-full shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          <div class="filter-selector text-center md:text-left">
            <label for="categoryFilter" class="mr-2 font-semibold text-gray-700">Filter by Category:</label>
            <select id="categoryFilter" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
              <option value="all">All Products</option>
              <option value="keychains">Keychains</option>
              <option value="artSupplies">Art Supplies</option>
              <option value="stationery">Stationery</option>
              <option value="diaries">Diaries</option>
            </select>
          </div>
      </div>
      <div id="productsContainer" class="relative">
          <!-- Product cards will be loaded here -->
          <div class="loader"></div> <!-- Initial loader -->
      </div>
    </div>
  </section>

  <!-- Product Request Section -->
  <section id="request" class="py-20 bg-gray-50 px-6">
    <div class="max-w-2xl mx-auto text-center">
      <h2 class="text-4xl font-bold mb-8 text-gray-800">Request a Product</h2>
      <div class="product-request-form bg-white p-8 rounded-xl shadow-md">
        <form id="requestForm" action="https://formsubmit.co/thehighonsofficial@gmail.com" method="POST" class="space-y-6 text-left">
          <!-- !! UPDATE THIS URL if you have a thank you page -->
          <input type="hidden" name="_next" value="https://YOUR_WEBSITE.com/thank-you-request.html"> <!-- Replace with your actual thank you page URL -->
          <input type="hidden" name="_subject" value="New Product Request from The Highon's Site">
          <input type="hidden" name="_captcha" value="false"> <!-- Consider enabling reCAPTCHA later -->
          <div>
            <label for="requestName" class="block font-semibold mb-2 text-gray-700">Product Name</label>
            <input type="text" id="requestName" name="product" placeholder="What product are you looking for?" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
          </div>
          <div>
            <label for="requestDetails" class="block font-semibold mb-2 text-gray-700">Additional Details</label>
            <textarea id="requestDetails" name="details" rows="4" placeholder="Any specific brand, color, size or other details?" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
          </div>
          <div>
            <label for="requestEmail" class="block font-semibold mb-2 text-gray-700">Your Email</label>
            <input type="email" id="requestEmail" name="email" placeholder="Your email address" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
          </div>
          <button type="submit" class="w-full btn-primary text-white py-4 rounded-lg font-medium">Submit Request</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Order Section -->
  <section id="order" class="py-20 bg-white px-6">
    <div class="max-w-2xl mx-auto text-center">
      <h2 class="text-4xl font-bold mb-8 text-gray-800">Place Your Order</h2>
      <!-- Login/User Info Form -->
      <div id="loginForm" class="space-y-6 text-left bg-white p-8 rounded-xl shadow-md">
        <h3 class="text-2xl font-semibold mb-6 text-gray-700">Your Information</h3>
        <input type="text" id="name" placeholder="Full Name" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
        <input type="email" id="email" placeholder="Email" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
        <input type="tel" id="phone" placeholder="Phone (+91)" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required pattern="[6-9]\d{9}"> <!-- Added pattern for basic validation -->
        <input type="text" id="address" placeholder="Full Address (Navsari)" class="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
        <button onclick="saveUser()" class="w-full btn-primary text-white py-4 rounded-lg font-medium mt-4">Save & Continue</button>
      </div>
      <!-- Order Form (Initially Hidden) -->
      <form id="orderForm" action="https://formsubmit.co/thehighonsofficial@gmail.com" method="POST" class="space-y-6 text-left bg-white p-8 rounded-xl shadow-md hidden">
        <!-- !! UPDATE THIS URL if you have a thank you page -->
        <input type="hidden" name="_next" value="https://YOUR_WEBSITE.com/thank-you-order.html"> <!-- Replace with your actual thank you page URL -->
        <input type="hidden" name="_captcha" value="false"> <!-- Consider enabling reCAPTCHA later -->
        <input type="hidden" name="_subject" value="New Order from The Highon's Site!">
        <!-- User details will be added here by JS -->
        <input type="hidden" name="name" id="formName">
        <input type="hidden" name="email" id="formEmail">
        <input type="hidden" name="phone" id="formPhone">
        <input type="hidden" name="address" id="formAddress">
        <!-- The detailed order summary will be put here -->
        <input type="hidden" name="message" id="orderSummaryText">

        <h3 class="text-2xl font-semibold mb-6 text-gray-700">Order Summary</h3>
        <div class="mb-6">
          <label for="coupon" class="block font-semibold mb-2 text-gray-700">Have a coupon code?</label>
          <input type="text" id="coupon" placeholder="Enter code if you have one" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div id="cartSummary" class="bg-gray-50 border border-gray-200 rounded-xl p-6 mb-6">
          <h3 class="font-semibold text-lg mb-4 text-gray-800">Your Cart Items</h3>
          <ul id="cartItems" class="space-y-3 mb-4"></ul>
          <div class="border-t border-gray-200 pt-4">
              <div id="summarySubtotalRow" class="flex justify-between mb-2"> <!-- Added Subtotal explicitly -->
                  <span class="font-semibold">Subtotal:</span>
                  <span class="font-semibold">₹<span id="summarySubtotal">0</span></span>
              </div>
              <div id="summaryDiscountRow" class="flex justify-between mb-2 hidden">
                  <span class="font-semibold">Discount:</span>
                  <span class="font-semibold text-green-600">-₹<span id="summaryDiscount">0</span></span>
              </div>
              <p class="text-lg font-bold text-gray-800 flex justify-between"> <!-- Made total a flex row -->
                <span>Total:</span>
                <span>₹<span id="cartTotal">0</span></span>
              </p>
          </div>
        </div>
        <div class="mb-6">
          <label for="payment" class="block font-semibold mb-2 text-gray-700">Payment Option:</label>
          <select id="payment" name="payment" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
            <option value="COD">Cash on Delivery</option>
            <option value="UPI">UPI Payment</option>
          </select>
        </div>
        <div class="text-center bg-gray-50 p-4 rounded-lg mb-6">
          <p class="font-semibold mb-3 text-gray-700">Scan to Pay via UPI:</p>
          <img src="1000022591.jpg" alt="UPI QR Code" class="w-48 mx-auto rounded-lg shadow" loading="lazy">
        </div>
        <button type="submit" onclick="return prepareOrder()" class="w-full btn-primary text-white py-4 rounded-lg font-medium">Confirm Order</button>
      </form>
      <p class="text-sm mt-6 text-gray-500">* Orders are only delivered within Navsari - 396445 *</p>
    </div>
  </section>

  <!-- Contact -->
  <section id="contact" class="bg-gray-50 py-20 text-center px-6">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-4xl font-bold mb-8 text-gray-800">Get In Touch</h2>
      <div class="grid md:grid-cols-1 gap-8 text-left">
        <div class="bg-white p-8 rounded-xl shadow-sm">
          <h3 class="text-xl font-semibold mb-4 text-gray-800">Contact Information</h3>
          <p class="text-lg mb-2"><span class="font-medium">Email:</span> <a href="mailto:thehighonsofficial@gmail.com" class="text-purple-600 hover:text-purple-800">thehighonsofficial@gmail.com</a></p>
          <div class="flex space-x-4 mt-6">
            <a href="https://instagram.com/thehighons" target="_blank" rel="noopener noreferrer" class="text-gray-700 hover:text-purple-600 transition"><i class="fab fa-instagram text-2xl"></i></a>
            <!-- Add other social links here if needed -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-auto">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-6 md:mb-0 text-center md:text-left">
          <span class="text-2xl font-bold tracking-wide brand-name text-white">THE HIGHON'S</span>
          <p class="mt-2 text-gray-400">Innovating with Purpose</p>
        </div>
        <div class="flex flex-wrap justify-center gap-6">
          <a href="#products" class="text-gray-300 hover:text-white transition">Products</a>
          <a href="#features" class="text-gray-300 hover:text-white transition">Why Choose Us</a>
          <a href="#order" class="text-gray-300 hover:text-white transition">Order</a>
          <a href="#request" class="text-gray-300 hover:text-white transition">Request</a>
          <a href="#contact" class="text-gray-300 hover:text-white transition">Contact</a>
        </div>
      </div>
      <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500 text-sm">
        <p> <span id="footerYear"></span> The Highon's.</p>
      </div>
    </div>
  </footer>

  <!-- Modals -->
  <div id="productModal" class="fixed inset-0 z-[70] bg-black bg-opacity-50 flex items-center justify-center hidden p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl relative max-w-md w-full mx-auto animate__animated animate__zoomIn animate__faster">
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl leading-none">×</button>
      <img id="modalImg" src="" alt="" class="w-full h-64 object-contain rounded-lg mb-6" loading="lazy">
      <h3 id="modalName" class="text-2xl font-bold mb-2 text-gray-800"></h3>
      <p id="modalDesc" class="text-gray-600 mb-4"></p>
      <p id="modalPrice" class="text-xl font-semibold text-purple-600 mb-6"></p>
      <button id="modalAddToCart" class="w-full btn-primary text-white py-3 rounded-lg font-medium">Add to Cart</button>
    </div>
  </div>

  <div id="orderConfirmation" class="fixed inset-0 z-[70] bg-black bg-opacity-50 flex items-center justify-center hidden p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl relative max-w-md w-full mx-auto text-center animate__animated animate__zoomIn animate__faster">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check text-green-500 text-3xl"></i>
      </div>
      <h3 class="text-2xl font-bold mb-4 text-gray-800">Order Confirmed!</h3>
      <p class="text-gray-600 mb-6">Thank you for your purchase. We've received your order details via email and will contact you shortly if needed.</p>
      <button onclick="closeOrderConfirmation()" class="btn-primary text-white px-8 py-3 rounded-lg font-medium">Continue Shopping</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // --- Product Data ---
    const products = {
         keychains: [
            { name: "Thor Loki Keychain", price: 99, img: "Screenshot_20250422_132243_Meesho.jpg", desc: "High-quality metal keychain featuring Thor and Loki designs" },
            { name: "Thor Hammer Keychain", price: 89, img: "Screenshot_20250422_131740_Meesho.jpg", desc: "Durable Mjolnir keychain with detailed engraving" },
            { name: "Demon slayer katana keychain", price: 159, img: "Screenshot_20250424_141150_Meesho.jpg", desc: "Miniature katana keychain from Demon Slayer anime" },
            { name: "Pikachu Keychain", price: 109, img: "Screenshot_20250422_131948_Meesho.jpg", desc: "Cute Pikachu keychain with enamel finish" }
        ],
        artSupplies: [
            { name: "Camel water colour tube", price: 169, img: "Screenshot_20250424_134214_Meesho.jpg", desc: "Professional-grade watercolor tubes, set of 12 vibrant colors" },
            { name: "FLAIR Acrylic marker", price: 359, img: "Screenshot_20250423_144509_Meesho.jpg", desc: "Premium acrylic paint markers, fine tip for detailed work" },
            { name: "Levin Acrylic Markers", price: 409, img: "Screenshot_20250423_140558_Meesho.jpg", desc: "Dual-tip acrylic markers with broad and fine tips" },
            { name: "Marker Set of 48", price: 299, img: "Touch-48-Color-Marker-Pen-Set-Kids-Art-Essentials-Double-Ended-Vibrant-Colors-Non-Bleeding-Wholesale-Discount-.webp", desc: "48-color marker set with dual tips for versatility" },
            { name: "Markers Set of 24", price: 179, img: "81B5uZXhYEL._AC_UF1000,1000_QL80_.jpg", desc: "24-color marker set, perfect for beginners" },
            { name: "Paint Brush 12 sizes", price: 89, img: "Screenshot_20250423_195924_Meesho.jpg", desc: "Professional paint brush set with 12 different sizes" },
            { name: "Sponge Dabbing Brush 5 Piece Set", price: 90, img: "41fvlzAzMWL._AC_.jpg", desc: "Sponge brush set for texture painting and special effects" },
            { name: "Camel artist gesso 100ml + Decor varnish combo", price: 259, img: "camel-combo.jpg", desc: "Premium gesso and varnish combo for professional art projects" }
        ],
        stationery: [
            { name: "correction tape", price: 70, img: "51l7S8XUY0L.jpg", desc: "Smooth correction tape for error-free writing" },
            { name: "Hot Melt Glue Gun", price: 220, img: "71xHhYjWcIL.jpg", desc: "20W glue gun with 5 glue sticks included" },
            { name: "Sketch Kit", price: 619, img: "Screenshot_20250423_205027_Meesho.jpg", desc: "Complete sketching kit with pencils, erasers and sharpeners" },
            { name: "luxury Pen", price: 199, img: "Screenshot_20250422_001401.jpg", desc: "Premium metal body pen with smooth ink flow" },
            { name: "Sketch book A5 100pg", price: 119, img: "Screenshot_20250423_204415_Meesho.jpg", desc: "A5 size sketchbook with 100gsm paper, 100 pages" }
        ],
        diaries: [
            { name: "Diary", price: 249, img: "81EROqfMQBL._AC_UF1000,1000_QL80_.jpg", desc: "Hardcover diary with premium paper and ribbon marker" },
            { name: "Diary Premium", price: 319, img: "IMG-20250422-WA0005.jpg", desc: "Premium leather-bound diary with lock and key" },
            { name: "Diary Mini", price: 219, img: "Screenshot_20250422_215326_Meesho.jpg", desc: "Compact pocket diary with elastic closure" },
            { name: "Vintage Handmade Genuine Leather Journal", price: 499, img: "vintage-journal.jpg", desc: "Premium handcrafted leather diary with handmade paper" }
        ]
    };

    // --- State Variables ---
    let cart = []; // Initialized later from localStorage
    let currentModalProduct = null;
    let currentCategory = 'all';
    let appliedCoupon = null;

    // --- Core Functions ---

    function renderProducts(category = 'all', searchTerm = '') {
        const container = document.getElementById("productsContainer");
        if (!container) { console.error("productsContainer not found!"); return; }
        container.innerHTML = '<div class="loader"></div>'; // Show loader

        // Use requestAnimationFrame for smoother rendering start
        requestAnimationFrame(() => {
            try {
                container.innerHTML = ''; // Clear loader/previous content
                let hasProducts = false;
                const searchTermLower = searchTerm.toLowerCase().trim();

                // Function to create a category section
                const createCategorySection = (catKey, items) => {
                    const filtered = items.filter(item =>
                        !searchTermLower || // Show all if no search term
                        item.name.toLowerCase().includes(searchTermLower) ||
                        item.desc.toLowerCase().includes(searchTermLower)
                    );

                    if (filtered.length > 0) {
                        hasProducts = true;
                        const section = document.createElement('div');
                        section.className = 'mb-16';
                        const title = catKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        // Only show title if filtering by 'all' or if it's the single category being shown
                        if (category === 'all' || category === catKey) {
                            section.innerHTML = `<h3 class="category-title">${title}</h3>`;
                        }
                        const grid = document.createElement('div');
                        grid.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8';
                        grid.id = `${catKey}List`;
                        section.appendChild(grid); // Append grid to section
                        container.appendChild(section); // Append section to container

                        filtered.forEach((product) => {
                            const originalIndex = products[catKey].findIndex(p => p.name === product.name);
                            if (originalIndex !== -1) { // Ensure index is found
                                grid.appendChild(createProductCard(product, originalIndex, catKey));
                            } else {
                                console.warn(`Product ${product.name} not found in original ${catKey} list for indexing.`);
                            }
                        });
                    }
                };

                if (category === 'all') {
                    Object.entries(products).forEach(([catKey, items]) => {
                        createCategorySection(catKey, items);
                    });
                } else if (products[category]) {
                    createCategorySection(category, products[category]);
                }

                if (!hasProducts) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">No products found matching your criteria.</p>';
                } else {
                     animateCards(); // Animate cards after they are added
                }
            } catch (error) {
                console.error("Error rendering products:", error);
                container.innerHTML = '<p class="text-center text-red-500 py-12 text-lg">Error loading products. Please try again later.</p>';
            }
        }); // End requestAnimationFrame
    }

    function createProductCard(product, index, category) {
        const card = document.createElement("div");
        card.id = `product-${category}-${index}`;
        // Add animate__animated here, specific animation added by animateCards()
        card.className = "product-card animate__animated";

        const itemInCart = cart.find(item => item.name === product.name);
        const productNameSafe = escapeHtml(product.name); // Sanitize name

        // Use template literals and structure for clarity
        card.innerHTML = `
            <div class="relative overflow-hidden rounded-t-lg h-56 bg-gray-100 flex items-center justify-center p-2 cursor-pointer" onclick="showModal('${category}', ${index})">
                <img src="${escapeHtml(product.img)}" alt="${productNameSafe}" class="max-w-full max-h-full object-contain transition duration-300 hover:scale-105" loading="lazy">
            </div>
            <div class="product-card-content">
                 <div> <!-- Top content wrapper -->
                    <h3 class="text-lg font-semibold mb-1 text-gray-800">${productNameSafe}</h3>
                    <p class="text-sm text-gray-500 mb-3 min-h-[40px]">${escapeHtml(product.desc.substring(0, 50))}${product.desc.length > 50 ? '...' : ''}</p>
                    <span class="block text-xl font-bold text-purple-600 mb-4">₹${product.price}</span>
                </div>
                <div class="product-card-controls mt-auto"> <!-- Controls wrapper -->
                    ${itemInCart ? `
                        <div class="quantity-controls">
                            <button onclick="event.stopPropagation(); updateQty('${category}', ${index}, -1)" class="quantity-btn" aria-label="Decrease quantity of ${productNameSafe}">-</button>
                            <span class="quantity-display">${itemInCart.qty}</span>
                            <button onclick="event.stopPropagation(); updateQty('${category}', ${index}, 1)" class="quantity-btn" aria-label="Increase quantity of ${productNameSafe}">+</button>
                        </div>` : `
                        <button onclick="event.stopPropagation(); addToCart('${category}', ${index})" class="w-full btn-primary text-white py-2 px-4 rounded-lg hover:shadow-md transition">Add to Cart</button>`
                    }
                </div>
            </div>
        `;
        // Added event.stopPropagation() to buttons to prevent triggering showModal
        // Added aria-labels for accessibility
        return card;
    }


    // --- Cart Functionality ---

    function addToCart(category, index) {
        try {
            const product = products[category]?.[index];
            if (!product) {
                console.error("Product not found for:", category, index);
                return;
            }
            const existingIndex = cart.findIndex(p => p.name === product.name);

            if (existingIndex > -1) {
                cart[existingIndex].qty++;
            } else {
                // Add category and index to the item for easier reference later
                cart.push({ ...product, qty: 1, category: category, index: index });
            }

            saveCart();
            updateProductCard(category, index);
            updateCartUI(); // Update all UI elements related to cart
        } catch (error) {
            console.error("Error adding to cart:", error);
        }
    }

    function updateQty(category, index, change) {
       try {
            const product = products[category]?.[index];
            if (!product) {
                console.error("Cannot update quantity, product info not found for:", category, index);
                return;
            }
            const itemIndex = cart.findIndex(p => p.name === product.name);

            if (itemIndex > -1) {
                const newQty = cart[itemIndex].qty + change;
                if (newQty <= 0) {
                    cart.splice(itemIndex, 1); // Remove item
                } else {
                    cart[itemIndex].qty = newQty; // Update quantity
                }
                saveCart();
                updateProductCard(category, index); // Update the specific product card
                updateCartUI(); // Update cart panel and counters
            } else if (change > 0) {
                // If item not found and change is positive, treat as adding the first item
                addToCart(category, index);
            } else {
                 console.warn(`Attempted to decrease quantity for item not in cart: ${product.name}`);
            }
       } catch (error) {
            console.error("Error updating quantity:", error);
       }
    }

    function updateProductCard(category, index) {
        // Only proceed if the product exists in the original data
        const product = products[category]?.[index];
        if (!product) return;

        const cardId = `product-${category}-${index}`;
        const card = document.getElementById(cardId);
        // Only proceed if the card element exists in the current DOM
        if (!card) return;

        const controlsContainer = card.querySelector('.product-card-controls');
        if (!controlsContainer) {
            console.warn(`Controls container not found for card: ${cardId}`);
            return;
        }

        try {
            const itemInCart = cart.find(item => item.name === product.name);
            const productNameSafe = escapeHtml(product.name); // Sanitize name

            controlsContainer.innerHTML = itemInCart ? `
                <div class="quantity-controls">
                     <button onclick="event.stopPropagation(); updateQty('${category}', ${index}, -1)" class="quantity-btn" aria-label="Decrease quantity of ${productNameSafe}">-</button>
                     <span class="quantity-display">${itemInCart.qty}</span>
                     <button onclick="event.stopPropagation(); updateQty('${category}', ${index}, 1)" class="quantity-btn" aria-label="Increase quantity of ${productNameSafe}">+</button>
                </div>` : `
                <button onclick="event.stopPropagation(); addToCart('${category}', ${index})" class="w-full btn-primary text-white py-2 px-4 rounded-lg hover:shadow-md transition">Add to Cart</button>`;
        } catch (error) {
            console.error(`Error updating product card controls for ${category}-${index}:`, error);
            // Optionally revert to a default state or show an error message in the card
            controlsContainer.innerHTML = `<p class="text-red-500 text-xs">Error updating controls</p>`;
        }
    }

    function updateCartUI() {
        try {
            updateCartCounter();
            updateCartPanel(); // This recalculates and redraws the panel
            updateOrderSummary(); // Update the order form summary as well
        } catch(error) {
            console.error("Error updating cart UI:", error);
        }
    }

    function saveCart() {
        try {
            localStorage.setItem('cart', JSON.stringify(cart));
        } catch (error) {
            console.error("Error saving cart to localStorage:", error);
            alert("Warning: Could not save cart changes. Your browser's storage might be full or disabled.");
        }
    }

    function loadCart() {
        try {
            const storedCart = localStorage.getItem('cart');
            cart = storedCart ? JSON.parse(storedCart) : [];
            if (!Array.isArray(cart)) {
                console.warn("Invalid cart data found in localStorage. Resetting cart.");
                cart = [];
                saveCart();
            }
            cart = cart.filter(item => item && typeof item.name === 'string' && typeof item.price === 'number' && typeof item.qty === 'number' && item.qty > 0);
        } catch (error) {
            console.error("Error loading cart from localStorage:", error);
            cart = []; // Reset to empty cart on error
        }
    }

    function updateCartPanel() {
        const panelItems = document.getElementById("cartPanelItems");
        const subtotalEl = document.getElementById("cartPanelSubtotal");
        const totalEl = document.getElementById("cartPanelTotal");
        const discountRow = document.getElementById("discountRow");
        const discountEl = document.getElementById("cartPanelDiscount");
        const emptyCartMsg = document.getElementById("emptyCartMessage");
        const cartFooter = document.getElementById("cartPanelFooter");
        const cartCouponInput = document.getElementById('cartCoupon');

        if (!panelItems || !subtotalEl || !totalEl || !discountRow || !discountEl || !emptyCartMsg || !cartFooter || !cartCouponInput) {
            console.error("One or more cart panel elements not found! Cannot update panel.");
            return;
        }

        panelItems.innerHTML = ''; // Clear previous items
        let subtotal = 0;

        try {
            if (cart.length === 0) {
                emptyCartMsg.classList.remove('hidden');
                cartFooter.classList.add('hidden');
                discountRow.classList.add('hidden');
                appliedCoupon = null; // Reset coupon if cart is empty
                cartCouponInput.value = ''; // Clear coupon input visual
            } else {
                emptyCartMsg.classList.add('hidden');
                cartFooter.classList.remove('hidden');

                cart.forEach(item => {
                    const itemName = item.name || 'Unknown Item';
                    const itemImg = item.img || 'placeholder.jpg';
                    const itemPrice = typeof item.price === 'number' ? item.price : 0;
                    const itemQty = typeof item.qty === 'number' ? item.qty : 0;
                    const itemTotal = itemPrice * itemQty;
                    subtotal += itemTotal;

                     const safeItemName = escapeHtml(itemName); // Use already escaped name
                     const safeItemNameForAttr = itemName.replace(/'/g, "\\'").replace(/"/g, '\\"'); // Escape for JS string in attribute

                    panelItems.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                <img src="${escapeHtml(itemImg)}" alt="${safeItemName}" class="w-16 h-16 object-contain rounded border border-gray-200 flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-sm truncate">${safeItemName}</h4>
                                    <p class="text-xs text-gray-600">₹${itemPrice} × ${itemQty} = ₹${itemTotal}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1 flex-shrink-0 ml-2">
                                <button onclick="updateQtyFromPanel('${safeItemNameForAttr}', -1)" class="quantity-btn" aria-label="Decrease quantity of ${safeItemName}">-</button>
                                <span class="quantity-display">${itemQty}</span>
                                <button onclick="updateQtyFromPanel('${safeItemNameForAttr}', 1)" class="quantity-btn" aria-label="Increase quantity of ${safeItemName}">+</button>
                            </div>
                        </div>
                    `;
                });

                subtotalEl.textContent = subtotal;

                // Recalculate total with coupon if applied
                let total = subtotal;
                let discount = 0;
                if (appliedCoupon === "NSL10%") {
                    discount = Math.round(subtotal * 0.10);
                    total = subtotal - discount;
                    discountEl.textContent = discount;
                    discountRow.classList.remove('hidden');
                } else {
                    discountRow.classList.add('hidden');
                }
                totalEl.textContent = total;
                cartCouponInput.value = appliedCoupon ? appliedCoupon : '';
            }
        } catch (error) {
             console.error("Error updating cart panel content:", error);
             panelItems.innerHTML = '<p class="text-red-500">Error loading cart items.</p>';
             cartFooter.classList.add('hidden'); // Hide footer on error
        }
    }

    function updateQtyFromPanel(name, change) {
        // console.log(`updateQtyFromPanel called for: ${name}, change: ${change}`); // Debug
        try {
            const itemIndex = cart.findIndex(p => p.name === name);
            if (itemIndex > -1) {
                 const item = cart[itemIndex];
                 const category = item.category;
                 const index = item.index;

                 if (category !== undefined && index !== undefined && products[category]?.[index]?.name === name) {
                    //  console.log(`Using updateQty for ${category}[${index}]`); // Debug
                     updateQty(category, index, change);
                 } else {
                     console.warn(`Fallback: Could not find original product info for ${name}. Updating cart directly.`);
                     const newQty = cart[itemIndex].qty + change;
                     if (newQty <= 0) {
                         cart.splice(itemIndex, 1);
                     } else {
                         cart[itemIndex].qty = newQty;
                     }
                     saveCart();
                     updateCartUI(); // Refresh everything
                 }
            } else {
                 console.warn("Item not found in cart for panel update:", name);
            }
        } catch (error) {
            console.error("Error in updateQtyFromPanel:", error);
        }
    }

    function updateOrderSummary() {
        const list = document.getElementById("cartItems");
        const subtotalEl = document.getElementById("summarySubtotal"); // Get subtotal element
        const totalEl = document.getElementById("cartTotal");
        const summarySubtotalRow = document.getElementById("summarySubtotalRow"); // Get subtotal row
        const summaryDiscountRow = document.getElementById("summaryDiscountRow");
        const summaryDiscountEl = document.getElementById("summaryDiscount");
        const orderForm = document.getElementById("orderForm");
        const couponInput = document.getElementById('coupon');

        if (!list || !subtotalEl || !totalEl || !summarySubtotalRow || !summaryDiscountRow || !summaryDiscountEl || !orderForm || !couponInput) {
            console.error("One or more order summary elements not found! Cannot update.");
            return;
        }

        list.innerHTML = '';
        let subtotal = 0;

        try {
            if (cart.length === 0) {
                list.innerHTML = '<li class="text-gray-500">Your cart is empty.</li>';
                subtotalEl.textContent = 0; // Set subtotal to 0
                totalEl.textContent = 0;    // Set total to 0
                summarySubtotalRow.classList.add('hidden'); // Hide subtotal row if empty
                summaryDiscountRow.classList.add('hidden');
            } else {
                summarySubtotalRow.classList.remove('hidden'); // Show subtotal row if cart has items
                cart.forEach(item => {
                    const itemPrice = item.price || 0;
                    const itemQty = item.qty || 0;
                    const itemTotal = itemPrice * itemQty;
                    subtotal += itemTotal;
                    list.innerHTML += `
                        <li class="cart-item flex justify-between items-center text-sm">
                            <span class="flex-1 mr-2 truncate">${escapeHtml(item.name || 'Unknown Item')} (×${itemQty})</span>
                            <span class="font-semibold flex-shrink-0">₹${itemTotal}</span>
                        </li>
                    `;
                });

                 subtotalEl.textContent = subtotal; // Update subtotal display

                 // Apply coupon discount
                let finalTotal = subtotal;
                let discount = 0;
                const couponCode = couponInput.value.trim().toUpperCase();

                // Check coupon from order form OR globally applied one
                const effectiveCoupon = couponCode === "NSL10%" ? "NSL10%" : (appliedCoupon === "NSL10%" && couponCode === "" ? "NSL10%" : null);

                if (effectiveCoupon === "NSL10%") {
                    discount = Math.round(subtotal * 0.10);
                    finalTotal = subtotal - discount;
                    summaryDiscountEl.textContent = discount;
                    summaryDiscountRow.classList.remove('hidden');
                    // Optionally sync order form input if coupon came from global state
                    if (couponCode === "" && appliedCoupon === "NSL10%") {
                        couponInput.value = appliedCoupon;
                    }
                } else {
                    summaryDiscountRow.classList.add('hidden');
                     // If user cleared coupon input, ensure global state reflects that
                    if (couponCode === "" && appliedCoupon) {
                        appliedCoupon = null;
                        updateCartPanel(); // Update panel as well
                    }
                }
                totalEl.textContent = finalTotal;
            }
        } catch (error) {
            console.error("Error updating order summary:", error);
            list.innerHTML = '<li class="text-red-500">Error loading summary.</li>';
        }
    }


    function updateCartCounter() {
        const counter = document.getElementById('cartCounter');
        const mobileCounter = document.getElementById('cartCounterMobile');
        if (!counter || !mobileCounter) {
             console.warn("Cart counter elements not found.");
             return;
        }

        try {
            const totalItems = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
            counter.textContent = totalItems;
            mobileCounter.textContent = totalItems;
            counter.classList.toggle('hidden', totalItems === 0);
            mobileCounter.classList.toggle('hidden', totalItems === 0);
        } catch (error) {
            console.error("Error updating cart counter:", error);
            counter.classList.add('hidden');
            mobileCounter.classList.add('hidden');
        }
    }

    // --- UI Interaction Functions ---

    function toggleCart() {
        const cartPanel = document.getElementById('cartPanel');
        const overlay = document.getElementById('cartOverlay');
        const body = document.body;

        if (!cartPanel || !overlay || !body) {
            console.error("Cart panel, overlay, or body element not found!");
            return;
        }
        const isOpen = cartPanel.classList.contains('open');
        try {
            if (isOpen) {
                cartPanel.classList.remove('open');
                overlay.classList.remove('active');
                body.classList.remove('overflow-hidden');
            } else {
                updateCartPanel(); // Update content *before* showing
                cartPanel.classList.add('open');
                overlay.classList.add('active');
                body.classList.add('overflow-hidden');
            }
        } catch (error) {
            console.error("Error toggling cart visibility:", error);
            cartPanel.classList.remove('open');
            overlay.classList.remove('active');
            body.classList.remove('overflow-hidden');
        }
    }

    function proceedToCheckout() {
        if (cart.length === 0) {
            alert("Your cart is empty. Please add items before proceeding to checkout.");
            return;
        }
        toggleCart(); // Close cart if open

        setTimeout(() => {
             const orderSection = document.getElementById('order');
             if (orderSection) {
                const user = localStorage.getItem('user');
                const targetElement = user ? document.getElementById('orderForm') : document.getElementById('loginForm');
                const elementToScrollTo = targetElement && !targetElement.classList.contains('hidden') ? targetElement : orderSection; // Scroll to section if form hidden

                elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                updateOrderSummary();
             } else {
                 console.error("Order section (#order) not found!");
             }
        }, 450); // Match CSS transition duration + buffer
    }

    function applyCoupon() {
        const couponInput = document.getElementById('cartCoupon'); // Coupon input in CART PANEL
        if (!couponInput) {
            console.error("Cart panel coupon input not found!");
            return;
        }
        const couponCode = couponInput.value.trim().toUpperCase();

        if (couponCode === "NSL10%") {
            appliedCoupon = "NSL10%";
            alert('Coupon "NSL10%" applied successfully!');
        } else if (couponCode === "") {
             appliedCoupon = null;
             alert('Coupon removed.');
        } else {
            // Don't reset appliedCoupon if invalid, just clear input
            alert('Invalid coupon code.');
            couponInput.value = '';
        }
        updateCartPanel();
        updateOrderSummary(); // Reflect change in order form too
    }


    function showModal(category, index) {
       try {
            const product = products[category]?.[index];
            if (!product) {
                console.error("Product not found for modal:", category, index);
                return;
            }
            currentModalProduct = { category, index, name: product.name };

            const modalImg = document.getElementById('modalImg');
            const modalName = document.getElementById('modalName');
            const modalDesc = document.getElementById('modalDesc');
            const modalPrice = document.getElementById('modalPrice');
            const productModal = document.getElementById('productModal');
            const modalBtn = document.getElementById('modalAddToCart');

            if (!modalImg || !modalName || !modalDesc || !modalPrice || !productModal || !modalBtn) {
                 console.error("One or more modal elements not found!");
                 return;
            }

            modalImg.src = escapeHtml(product.img);
            modalImg.alt = escapeHtml(product.name); // Add alt text
            modalName.textContent = escapeHtml(product.name);
            modalDesc.textContent = escapeHtml(product.desc);
            modalPrice.textContent = `₹${product.price}`;

            const itemInCart = cart.find(item => item.name === product.name);
            modalBtn.textContent = itemInCart ? `Add One More (Qty: ${itemInCart.qty})` : 'Add to Cart';

            // Clone and replace button to remove old listeners before adding new one
            const newBtn = modalBtn.cloneNode(true);
            modalBtn.parentNode.replaceChild(newBtn, modalBtn);
            newBtn.addEventListener('click', addToCartFromModal);

            productModal.classList.remove('hidden');

       } catch (error) {
            console.error("Error showing modal:", error);
             const productModal = document.getElementById('productModal');
             if(productModal) productModal.classList.add('hidden');
       }
    }

    function closeModal() {
      const productModal = document.getElementById('productModal');
      if (productModal) {
        productModal.classList.add('hidden');
      }
      currentModalProduct = null;
    }

    function addToCartFromModal() {
        if (currentModalProduct) {
            const { category, index } = currentModalProduct;
            if (category !== undefined && index !== undefined && products[category]?.[index]) {
                addToCart(category, index);
                 const modalBtn = document.getElementById('modalAddToCart'); // Get the potentially replaced button
                 if (modalBtn) {
                     modalBtn.textContent = 'Added!';
                     modalBtn.disabled = true; // Briefly disable
                     setTimeout(() => {
                         closeModal();
                         modalBtn.disabled = false; // Re-enable after closing
                     }, 800);
                 } else {
                     closeModal();
                 }
            } else {
                 console.error("Invalid category/index in currentModalProduct:", currentModalProduct);
                 closeModal();
            }
        } else {
             console.warn("Add to cart from modal called with no current product selected.");
             closeModal();
        }
    }


    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      if (mobileMenu) {
        mobileMenu.classList.toggle('hidden');
      }
    }

    // --- User/Order Functions ---

    function saveUser() {
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');

        if (!nameInput || !emailInput || !phoneInput || !addressInput) {
            console.error("User info input fields not found!");
            alert("Error: Could not find user input fields.");
            return;
        }

        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const phone = phoneInput.value.trim();
        const address = addressInput.value.trim();

        let isValid = true;
        let errorMessage = "Please correct the following issues:\n";
        const emailRegex = /^\S+@\S+\.\S+$/;
        const phoneRegex = /^[6-9]\d{9}$/;

        [nameInput, emailInput, phoneInput, addressInput].forEach(input => input.classList.remove('border-red-500'));

        if (!name) { isValid = false; nameInput.classList.add('border-red-500'); errorMessage += "- Full Name is required.\n"; }
        if (!email || !emailRegex.test(email)) { isValid = false; emailInput.classList.add('border-red-500'); errorMessage += "- A valid Email is required.\n"; }
        if (!phone || !phoneRegex.test(phone)) { isValid = false; phoneInput.classList.add('border-red-500'); errorMessage += "- A valid 10-digit Indian phone number (starting with 6-9) is required.\n"; }
        if (!address) { isValid = false; addressInput.classList.add('border-red-500'); errorMessage += "- Full Address is required.\n"; }

        if (!isValid) {
            alert(errorMessage);
            return;
        }

        try {
            localStorage.setItem('user', JSON.stringify({ name, email, phone, address }));
            alert("Information saved successfully!");
            populateOrderForm();
            const orderForm = document.getElementById('orderForm');
            if (orderForm) {
                orderForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } catch (error) {
            console.error("Error saving user data to localStorage:", error);
            alert("Could not save your information due to a browser storage issue. Please try again or enable storage.");
        }
    }

    function populateOrderForm() {
        const loginForm = document.getElementById('loginForm');
        const orderForm = document.getElementById('orderForm');

        if (!loginForm || !orderForm) {
            console.error("Login or Order form not found!");
            return;
        }

        try {
            const userString = localStorage.getItem('user');
            if (userString) {
                const user = JSON.parse(userString);
                 if (user && user.name && user.email && user.phone && user.address) {
                    const formName = document.getElementById('formName');
                    const formEmail = document.getElementById('formEmail');
                    const formPhone = document.getElementById('formPhone');
                    const formAddress = document.getElementById('formAddress');

                    if (formName) formName.value = user.name;
                    if (formEmail) formEmail.value = user.email;
                    if (formPhone) formPhone.value = user.phone;
                    if (formAddress) formAddress.value = user.address;

                    loginForm.classList.add('hidden');
                    orderForm.classList.remove('hidden');
                    updateOrderSummary();
                } else {
                    console.warn("User data in localStorage is incomplete. Clearing.");
                    localStorage.removeItem('user');
                    loginForm.classList.remove('hidden');
                    orderForm.classList.add('hidden');
                }
            } else {
                loginForm.classList.remove('hidden');
                orderForm.classList.add('hidden');
            }
        } catch (error) {
             console.error("Error parsing user data or populating order form:", error);
             localStorage.removeItem('user');
             loginForm.classList.remove('hidden');
             orderForm.classList.add('hidden');
        }
        updateLogoutButtonVisibility();
    }

    function logout() {
        if (!confirm("Are you sure you want to logout? Your saved details and cart will be cleared.")) {
            return;
        }
        try {
            localStorage.removeItem('user');
            localStorage.removeItem('cart');
            cart = [];
            appliedCoupon = null;
            alert("You have been logged out.");

            const loginForm = document.getElementById('loginForm');
            const orderForm = document.getElementById('orderForm');
            if (loginForm) loginForm.classList.remove('hidden');
            if (orderForm) orderForm.classList.add('hidden');

            // Clear login form inputs
            ['name', 'email', 'phone', 'address'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            // Clear coupon inputs
            ['cartCoupon', 'coupon'].forEach(id => {
                const input = document.getElementById(id);
                if(input) input.value = '';
            });

            updateLogoutButtonVisibility();
            updateCartUI();
            renderProducts(currentCategory, document.getElementById('productSearch')?.value || ''); // Re-render to reset cards
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            console.error("Error during logout:", error);
            alert("An error occurred during logout.");
            // Attempt partial cleanup
            cart = []; appliedCoupon = null;
            updateCartUI(); updateLogoutButtonVisibility();
        }
    }

    function updateLogoutButtonVisibility() {
        const logoutDesktop = document.getElementById('logoutButtonDesktop');
        const logoutMobile = document.getElementById('logoutButtonMobile');
        if (!logoutDesktop || !logoutMobile) {
            console.warn("Logout buttons not found.");
            return;
        }
        try {
            const user = localStorage.getItem('user');
            logoutDesktop.classList.toggle('hidden', !user);
            logoutMobile.classList.toggle('hidden', !user);
        } catch (error) {
             console.error("Error checking user status for logout button:", error);
             logoutDesktop.classList.add('hidden');
             logoutMobile.classList.add('hidden');
        }
    }

    function prepareOrder() {
        try {
            const userString = localStorage.getItem('user');
            if (!userString) {
                alert("Please save your information before placing the order.");
                document.getElementById('loginForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return false;
            }
            const user = JSON.parse(userString);

            if (cart.length === 0) {
                alert("Your cart is empty. Cannot place order.");
                toggleCart();
                return false;
            }

            updateOrderSummary(); // Ensure summary is fresh

            const couponInput = document.getElementById('coupon');
            const paymentSelect = document.querySelector('select[name="payment"]');
            const orderSummaryText = document.getElementById("orderSummaryText");
            const formName = document.getElementById('formName');
            const formEmail = document.getElementById('formEmail');
            const formPhone = document.getElementById('formPhone');
            const formAddress = document.getElementById('formAddress');

            if (!couponInput || !paymentSelect || !orderSummaryText || !formName || !formEmail || !formPhone || !formAddress) {
                 console.error("Essential order form elements missing!");
                 alert("Error: Order form is incomplete.");
                 return false;
            }

            // Sync hidden fields just in case
            formName.value = user.name; formEmail.value = user.email; formPhone.value = user.phone; formAddress.value = user.address;

            // Generate summary text
            const coupon = couponInput.value.trim().toUpperCase();
            let summary = `ORDER CONFIRMATION - The Highon's\n===============================\n`;
            summary += `CUSTOMER DETAILS:\n`;
            summary += `  Name:    ${user.name}\n  Email:   ${user.email}\n  Phone:   ${user.phone}\n  Address: ${user.address}\n`;
            summary += `===============================\nORDER ITEMS:\n`;

            let subtotal = 0;
            cart.forEach(item => {
                const itemTotal = (item.price || 0) * (item.qty || 0);
                summary += `  - ${item.name || 'Unknown Item'} (x${item.qty || 0})`.padEnd(40) + `₹${itemTotal}\n`;
                subtotal += itemTotal;
            });

            summary += `-------------------------------\n`;
            summary += `  Subtotal:`.padEnd(40) + `₹${subtotal}\n`;

            let total = subtotal;
            let discount = 0;
             // Use coupon from order form for final calculation
            if (coupon === "NSL10%") {
                discount = Math.round(subtotal * 0.10);
                summary += `  Discount (NSL10%):`.padEnd(40) + `-₹${discount}\n`;
                total -= discount;
            }

            summary += `===============================\n`;
            summary += `  TOTAL AMOUNT:`.padEnd(40) + `₹${total}\n`;
            summary += `===============================\n`;
            summary += `PAYMENT METHOD: ${paymentSelect.value}\n`;
            summary += `===============================\nThank you!\n`;

            orderSummaryText.value = summary;

            console.log("Order prepared. Summary set. Allowing form submission.");
            // console.log("Order Summary:\n", summary); // Optional: Log summary for debugging

            // Clear cart *after* successful submission confirmation (via _next page or AJAX)
            // For this example using FormSubmit's redirect, we clear it optimistically after a delay.
            // A more robust solution would involve checking on the thank-you page.
            setTimeout(() => {
                const orderConfirmation = document.getElementById('orderConfirmation');
                if (orderConfirmation) orderConfirmation.classList.remove('hidden');

                cart = [];
                saveCart();
                appliedCoupon = null;
                updateCartUI();
                renderProducts(currentCategory, document.getElementById('productSearch')?.value || '');
                // Clear coupon inputs
                ['cartCoupon', 'coupon'].forEach(id => {
                    const input = document.getElementById(id);
                    if(input) input.value = '';
                });

            }, 300); // Delay before showing confirmation modal

            return true; // Allow native form submission

        } catch (error) {
            console.error("Error preparing order:", error);
            alert("A critical error occurred while preparing your order. Please try again or contact support.");
            return false; // Prevent submission on error
        }
    }


    function closeOrderConfirmation() {
      const orderConfirmation = document.getElementById('orderConfirmation');
      if (orderConfirmation) orderConfirmation.classList.add('hidden');
      // Scroll to top or products section
      document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' });
    }

    // --- Helper Functions ---

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
             .replace(/&/g, "&") // Use & for ampersand
             .replace(/</g, "<")
             .replace(/>/g, ">")
             .replace(/"/g, """)
             .replace(/'/g, "'"); // Use HTML entity for single quote
    }


    function animateCards() {
        try {
            const cards = document.querySelectorAll('#productsContainer .product-card.animate__animated'); // Target cards with base class
            cards.forEach((card, index) => {
                // Ensure clean state before animation
                card.style.opacity = '0';
                card.classList.remove('animate__fadeInUp');

                // Apply animation with stagger
                card.style.animationDelay = `${index * 60}ms`; // Stagger delay

                // Use setTimeout to ensure styles are applied before adding class
                // Or use requestAnimationFrame for potentially smoother start
                requestAnimationFrame(() => {
                    setTimeout(() => { // Small delay helps ensure transition starts correctly
                        card.style.opacity = '1';
                        card.classList.add('animate__fadeInUp');
                         // **REMOVED** the animationend listener that removes the class.
                         // Let the class persist. The animation only runs once per class addition.
                         // Since elements are recreated on filter/search, new elements get animated.
                    }, 10);
                });
            });
        } catch (error) {
            console.error("Error animating product cards:", error);
        }
    }

    // --- Initialization ---
    window.onload = () => {
      // console.log("Window loaded. Initializing..."); // DEBUG
      try {
          const footerYear = document.getElementById('footerYear');
          if (footerYear) footerYear.textContent = new Date().getFullYear();

          loadCart();
          populateOrderForm();
          renderProducts();     // Initial render
          updateCartUI();
          // updateLogoutButtonVisibility is called within populateOrderForm

          // Event Listeners
          const productSearchInput = document.getElementById('productSearch');
          if (productSearchInput) {
              productSearchInput.addEventListener('input', function() {
                  renderProducts(currentCategory, this.value);
              });
          } else { console.error("Product search input not found."); }

          const categoryFilterSelect = document.getElementById('categoryFilter');
          if (categoryFilterSelect) {
               categoryFilterSelect.addEventListener('change', function() {
                  currentCategory = this.value;
                  const searchVal = document.getElementById('productSearch')?.value || '';
                  renderProducts(currentCategory, searchVal);
              });
          } else { console.error("Category filter select not found."); }

          const couponInput = document.getElementById('coupon');
          if (couponInput) {
              // Update summary on 'input' for immediate feedback, or 'change' if preferred
              couponInput.addEventListener('input', updateOrderSummary);
          } else { console.error("Order form coupon input not found."); }

          // Feature card Intersection Observer
          const featureCards = document.querySelectorAll('.feature-card');
          if ('IntersectionObserver' in window && featureCards.length > 0) {
              const observer = new IntersectionObserver((entries, obs) => {
                  entries.forEach(entry => {
                      if (entry.isIntersecting) {
                          entry.target.classList.add('animate__fadeInUp');
                          obs.unobserve(entry.target);
                      }
                  });
              }, { threshold: 0.1 });
              featureCards.forEach(card => observer.observe(card));
          } else {
              featureCards.forEach(card => card.style.opacity = '1'); // Fallback
          }

          // console.log("Initialization complete."); // DEBUG
      } catch (error) {
           console.error("Critical error during window.onload initialization:", error);
           alert("There was a significant error loading the page. Some features might be unavailable or broken. Please try refreshing.");
           document.body.innerHTML = `<div style="padding: 40px; text-align: center; font-family: sans-serif;"><h1>Oops!</h1><p>Something went wrong while loading the page. Please <a href="javascript:location.reload();">refresh</a> and try again.</p><p style="font-size: 0.8em; color: grey;">Error: ${escapeHtml(error.message)}</p></div>`;
      }
    };

  </script>

</body>
</html>